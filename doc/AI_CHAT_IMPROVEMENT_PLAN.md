# AI 상담 시스템 개선 계획서

## 문서 정보
- 작성일: 2025-12-12
- 버전: 1.0
- 목적: AI 상담 품질 향상 및 성능 최적화

---

## 목차

1. [개요](#1-개요)
2. [Phase 1: 대화 맥락 기능](#2-phase-1-대화-맥락-기능)
3. [Phase 2: 데이터 캐싱 시스템](#3-phase-2-데이터-캐싱-시스템)
4. [구현 순서 및 일정](#4-구현-순서-및-일정)
5. [예상 효과](#5-예상-효과)
6. [리스크 및 대응 방안](#6-리스크-및-대응-방안)
7. [성공 기준](#7-성공-기준)

---

## 1. 개요

### 1-1. 현재 문제점

**대화 맥락 부재**
- AI가 이전 대화를 기억하지 못함
- "왜 그럴까?" 같은 자연스러운 후속 질문을 이해하지 못함
- 매번 새로운 대화처럼 시작되어 사용자가 반복 설명 필요
- 깊이 있는 상담이 불가능

**데이터베이스 반복 조회**
- 사용자가 연속으로 질문할 때마다 동일한 7일치 데이터를 매번 데이터베이스에서 조회
- 서버 부하 증가
- 응답 시간 지연 (평균 2.2초)
- 동시 사용자 증가 시 성능 저하 우려

### 1-2. 개선 목표

**핵심 목표:**
1. 대화의 연속성 확보 (맥락 유지)
2. 데이터베이스 부하 90% 감소
3. 응답 속도 50% 향상
4. 실시간성 100% 보장 (새 기록 즉시 반영)

**중요 원칙:**
- **단 한 번의 오답도 허용 불가**: 아픈 아기의 체온, 투약 정보를 잘못 전달하면 즉시 신뢰 상실
- **실시간성 최우선**: 방금 기록한 데이터는 반드시 즉시 반영
- **안정성 우선**: 성능보다 정확성이 더 중요

---

## 2. Phase 1: 대화 맥락 기능

### 2-1. 핵심 아이디어

**AI가 대화를 요약하여 저장**

사용자와 AI의 대화가 끝날 때마다:
- AI에게 방금 대화를 요약하라고 요청
- 요약 결과를 데이터베이스에 저장 (ChatMessage 테이블의 summary 필드)
- 다음 질문이 들어오면 이전 대화 요약들을 AI에게 함께 전달
- AI가 맥락을 이해하고 자연스럽게 답변

### 2-2. 요약 방식 (완전히 AI에게 위임)

**저장 내용:**
- 사용자 질문: 원문 그대로 저장
- AI 답변: 3문장으로 요약

**요약 프롬프트:**
매우 단순하게 요청:
```
이 글의 핵심내용 3문장으로 요약
```

**AI에게 맡기는 것:**
- 어떤 내용이 중요한지
- 어떤 단어로 요약할지
- 어떤 정보를 남겨야 다음 대화에 도움이 될지
- 형식, 표현, 구성 등 모든 것

**형식 강요하지 않음:**
- "첫 문장은 이렇게, 두 번째 문장은..." 같은 제약 없음
- AI가 가장 적절하다고 판단하는 방식으로 요약

### 2-3. 요약 활용 방법

**대화 흐름 예시:**

**첫 번째 대화:**
- 사용자: "오늘 수유 몇 번 했어?"
- AI: "오늘 3번 했어요. 평소 7회보다 적네요. 모유 2회, 분유 1회였어요..."
- 요약 생성: 질문 원문 + AI 요약 3문장
  - 질문: "오늘 수유 몇 번 했어?"
  - 요약: "오늘 수유는 3번으로 평소 7회보다 적습니다. 모유 2회, 분유 1회였습니다. 일시적 감소로 보이며 걱정할 수준은 아닙니다."
- 데이터베이스 저장

**두 번째 대화:**
- 사용자: "어제는?"
- 시스템: 첫 번째 대화 요약 불러오기
- AI에게 전달: [이전 대화] 수유에 대해 물었음 + [현재 질문] "어제는?"
- AI 이해: "어제 수유 횟수"를 물어보는 것
- AI 답변: "어제는 5번이었어요..."
- 요약 저장

**세 번째 대화:**
- 사용자: "왜 줄었을까?"
- 시스템: 최근 3개 대화 요약 불러오기
- AI에게 전달: [오늘 3번, 어제 5번이라는 맥락] + [현재 질문] "왜 줄었을까?"
- AI 이해: "수유 횟수가 줄어든 이유"
- AI 답변: "수유량이 어제 5번에서 오늘 3번으로 줄었는데요, 성장 급등기 이후..."
- 요약 저장

### 2-4. 저장 및 활용 개수

**최근 3개 대화 요약만 활용:**
- 3개 미만: 맥락이 부족하여 자연스러운 대화 어려움
- 3개 초과: 토큰 낭비, 비용 증가, AI 혼란 가능성
- 3개가 최적의 균형점

**데이터베이스 저장:**
- 모든 대화는 계속 저장 (30일 후 삭제)
- AI에게 전달할 때만 최근 3개만 선택

### 2-5. 30일 오래된 대화 자동 삭제

**현재 상태:**
- 자동 삭제 기능 미구현

**추가 구현 필요:**
- 매일 자동으로 실행되는 스케줄 작업 생성
- 생성일 기준 30일 이상 지난 ChatMessage 찾기
- 오래된 순서대로 삭제

**순차 삭제의 장점:**
- 항상 최근 30일 데이터만 유지
- 최근 3개 요약은 언제나 30일 이내 데이터 (유효함)
- 별도의 장기 요약 테이블 불필요
- 데이터베이스 용량 자동 관리

### 2-6. 추가 비용

**요약 생성 비용:**
- 1회 대화 요약: 약 0.01원 (매우 저렴)
- 월 100회 대화 가정: 1원

**토큰 증가:**
- 기존 프롬프트: 3,000 토큰/요청
- 요약 3개 추가: +450 토큰
- 합계: 3,450 토큰/요청
- 증가율: 15%

**월 비용:**
- 기존: 4,500원
- 개선 후: 5,500원
- 증가: 1,000원 (스타벅스 아메리카노 1잔)

**투자 대비 효과:**
- 월 1,000원으로 대화 품질 극적 향상
- 사용자 만족도 증가 → 재방문율 증가
- 충분히 가치 있는 투자

---

## 3. Phase 2: 데이터 캐싱 시스템

### 3-1. 핵심 아이디어

**Redis 메모리 캐시 활용**

현재: 질문마다 데이터베이스에서 7일치 데이터 조회 (느림)
개선: 한 번 조회한 데이터를 Redis에 임시 저장하여 재사용 (빠름)

**Redis란?**
- 초고속 메모리 기반 데이터 저장소
- 데이터베이스보다 10배 이상 빠름
- 임시 데이터 저장에 최적화

### 3-2. 작동 원리

**첫 번째 질문 (캐시 없음):**
1. Redis 확인: 저장된 데이터 없음
2. 데이터베이스 조회 (수유, 수면, 기저귀, 체온, 투약, 성장 7일치)
3. 데이터 가공 (한글 변환, 요약 계산 등)
4. Redis에 저장 (유효 기간 1일 설정)
5. AI에게 전달하여 답변 생성
6. 소요 시간: 약 700밀리초

**두 번째 질문 (10분 후, 캐시 있음):**
1. Redis 확인: 데이터 있음!
2. 데이터베이스 조회 건너뛰기
3. Redis에서 즉시 가져오기
4. AI에게 전달하여 답변 생성
5. 소요 시간: 약 200밀리초

**속도 차이:**
- 70% 빠른 응답
- 사용자 체감 성능 대폭 향상

### 3-3. 새 기록 추가 시 실시간 반영 (매우 중요!)

**핵심 문제:**
사용자가 아픈 아기의 체온을 재고 약을 먹인 후 바로 질문했는데, AI가 그 정보를 모른다면?
→ 즉시 신뢰 상실, 서비스 이탈

**해결 방법: 이중 안전장치**

**안전장치 1: 기록 즉시 캐시 삭제**

사용자가 체온 38.5도 기록:
1. 데이터베이스에 저장
2. 즉시 해당 아기의 Redis 캐시 삭제
3. "아기 123번 데이터 업데이트됨"을 Redis에 타임스탬프와 함께 기록

사용자가 바로 질문:
1. Redis 확인: 캐시 없음 (방금 삭제되었으니까)
2. 데이터베이스 다시 조회
3. 최신 데이터 (38.5도, 방금 먹인 약 포함) 가져옴
4. AI 답변: "38.5도는 높은 편이에요. 방금 드신 해열제 효과를 지켜봐주세요."

**안전장치 2: 10분 룰 (추가 보험)**

만약 캐시 삭제가 실패하거나 누락되었을 경우를 대비:
1. 질문이 들어오면 "마지막 업데이트 시간" 확인
2. 10분 이내에 기록이 있었다면 캐시 무시
3. 무조건 데이터베이스 재조회
4. 최신 데이터 보장

**왜 10분?**
- 5분: 너무 짧아서 캐시 효율 떨어짐
- 15분: 너무 길어서 오래된 데이터 제공 가능성
- 10분: 적절한 균형점

**두 안전장치가 함께 작동:**
- 정상 상황: 안전장치 1만으로 충분 (캐시 삭제)
- 캐시 삭제 실패: 안전장치 2가 작동 (10분 룰)
- 결과: 100% 실시간성 보장

### 3-4. 캐시 무효화 대상

**즉시 캐시 삭제가 필요한 경우:**

1. **활동 기록 (Activity 테이블)**
   - 수유 기록
   - 수면 기록
   - 기저귀 기록
   - 체온 기록
   - 투약 기록
   - **각 기록의 메모 필드 포함** (memo 컬럼)

2. **성장 기록 (BabyMeasurement 테이블)**
   - 체중 기록
   - 키 기록

**캐시 삭제가 불필요한 경우:**

1. **노트 (Note 테이블)**
   - 사용자 메모, 할 일, 일정 등
   - AI 답변에 직접 사용되지 않음
   - 캐시 삭제 시 불필요한 성능 저하

**구분 이유:**
- 활동 기록과 메모 필드: AI가 직접 참조하는 데이터
- 노트: 사용자 개인 기록용, AI 답변과 무관
- 불필요한 캐시 삭제 방지 → 성능 최적화

### 3-5. 캐시 유효 기간: 1일

**선택 이유:**

기록 앱의 특성:
- 사용자가 하루 평균 3~5회 기록
- 기록 직후 질문: 캐시 자동 삭제로 최신 데이터 보장
- 기록 없는 긴 시간: 캐시 재사용으로 빠른 응답

**실제 시나리오:**

아침 9시:
- 수유 기록 추가
- 캐시 삭제
- 질문: "오늘 수유량 어때?"
- 데이터베이스 조회 (최신 데이터)
- 새 캐시 생성 (유효기간 내일 9시까지)

9시 ~ 11시:
- 여러 질문들
- 모두 캐시 재사용
- 빠른 응답 (200밀리초)

점심 12시:
- 또 수유 기록 추가
- 캐시 삭제
- 새 캐시 생성

**1일이 적절한 이유:**
- 기록이 자주 있어 자연스럽게 캐시 갱신
- 기록 없으면 1일 내내 캐시 재사용 (효율적)
- 밤~아침 사이 긴 시간도 커버

### 3-6. Upstash Redis 설정

**이미 완료된 사항:**
- ✅ Upstash Redis 가입 완료
- ✅ 환경 변수 설정 완료
  - UPSTASH_REDIS_REST_URL
  - UPSTASH_REDIS_REST_TOKEN

**Upstash 선택 이유:**
- 무료 플랜: 하루 10,000 커맨드 (충분함)
- 99.99% 가용성 보장
- 서버리스 아키텍처 (관리 불필요)
- 글로벌 분산 서버 (빠른 속도)

---

## 3. Phase 3: DB 기반 대화 기록 복원 (v8 기반)

사라진 대화 기록 기능을 복원하고, 모든 대화를 데이터베이스에 안전하게 영구 저장하는 것을 최우선 목표로 합니다.

### 3-1. 핵심 목표
- **대화 기록 영속성:** 사용자가 앱을 종료하거나 다른 화면으로 이동해도 대화가 사라지지 않도록 `ChatMessage` 테이블에 영구 저장합니다.
- **강력한 보안:** `encryption.ts` 유틸리티를 100% 재사용하여, 대화의 핵심 내용(`message`, `reply`)을 모두 암호화하여 저장합니다.

### 3-2. 기능별 구현 계획

#### 3-2-1. 대화 기록 복원 (채팅방 입장 시)
- **트리거:** 사용자가 채팅방에 들어옵니다.
- **동작:**
    1. `useChatStore`는 Supabase의 `ChatMessage` 테이블에서 현재 아기의 전체 대화 기록을 조회하는 API를 호출합니다.
    2. API는 각 대화 데이터의 암호화된 `message`와 `reply` 컬럼 내용을 가져옵니다.
    3. 가져온 내용을 `encryption.ts`의 `decrypt` 함수로 복호화합니다.
    4. 복호화된 대화 목록을 화면에 보여주기 위해 스토어 상태를 업데이트합니다.

#### 3-2-2. 대화 기록 저장 (메시지 발생 시)
- **사용자 메시지 저장:**
    - 사용자가 메시지를 전송하면, 백엔드(`api/chat/route.ts`)는 AI에게 요청을 보내기 전에 **사용자 메시지 내용을 `encrypt` 함수로 암호화**합니다.
    - 암호화된 텍스트를 `ChatMessage` 테이블의 `message` 컬럼에 `INSERT`합니다.
- **AI 답변 저장:**
    - AI의 답변 스트리밍이 **클라이언트에서 모두 끝나면**, 완성된 전체 AI 답변을 백엔드의 별도 API(예: `/api/chat/save-reply`)로 전달합니다.
    - 백엔드는 전달받은 **AI 답변을 `encrypt` 함수로 암호화**하여 `ChatMessage` 테이블의 `reply` 컬럼에 `INSERT`합니다.

### 3-3. 기대 효과
- **데이터 영속성:** 모든 대화가 `ChatMessage` 테이블에 영구적으로 저장되어 더 이상 사라지지 않습니다.
- **강력한 보안:** 대화 내용이 암호화되어 데이터베이스가 유출되어도 안전합니다.
- **신뢰도:** 사용자는 자신의 대화 기록이 안전하게 보관되고 언제든 다시 볼 수 있다는 점에서 서비스에 대한 신뢰를 갖게 됩니다.

---

---

## 3. 최종 계획 (v9): DB 기반 대화 관리 및 UX 최적화

사라진 대화 기록 문제를 해결하고, 장기적인 확장성과 사용자 경험을 모두 고려한 최종 계획입니다.

### 3-1. 핵심 목표

- **대화 기록 영속성:** `ChatMessage` 테이블에 모든 대화를 암호화하여 영구 저장합니다.
- **빠른 로딩 속도:** 대화가 수천 개가 쌓여도 사용자는 채팅방에 즉시 진입할 수 있어야 합니다.
- **보안 및 재사용성:** 기존 `encryption.ts` 유틸리티를 100% 재사용하여 민감한 대화 내용을 보호합니다.
- **지능적인 맥락 유지:** 사용자 경험을 해치지 않는 선에서 대화 요약 기능을 구현합니다.

### 3-2. 기능별 구현 계획

#### 3-2-1. 대화 기록 저장 및 복원 (우선순위: 매우 높음)

- **저장 로직:**
  1. **사용자 메시지:** 사용자가 메시지를 보내면, 즉시 내용을 암호화하여 `ChatMessage` 테이블에 저장합니다.
  2. **AI 답변:** AI의 답변 스트리밍이 완료되면, 완성된 전체 답변을 암호화하여 `ChatMessage` 테이블에 저장합니다.
- **복원 로직 (커서 기반 무한 스크롤):**
  1. **초기 로딩:** 채팅방에 처음 진입 시, 가장 **최신 대화 10개**만 우선 불러와 화면에 보여줍니다.
  2. **추가 로딩:** 사용자가 대화 목록을 위로 스크롤하여 최상단에 도달하면, 현재 가장 오래된 메시지를 기준으로 이전 대화 10개를 추가로 불러와 목록 상단에 이어 붙입니다.

#### 3-2-2. 대화 요약 (비동기 방식) (우선순위: 높음)

- **트리거:** AI의 답변이 `ChatMessage` 테이블에 성공적으로 저장된 직후, 백그라운드에서 실행됩니다.
- **동작:**
  1. 별도의 요약 API가 방금 저장된 대화를 포함한 최근 대화 내용을 가져옵니다.
  2. 내용을 복호화하여 AI에게 "3문장 요약"을 요청합니다.
  3. AI에게 받은 요약문을 암호화하여, 해당 대화 세션의 마지막 `ChatMessage` 레코드의 `summary` 컬럼에 `UPDATE` 합니다.
- **기대 효과:** 사용자는 답변을 즉시 받아볼 수 있으며, 요약은 백그라운드에서 처리되므로 응답 지연이 없습니다.

---

## 4. 구현 순서 및 일정

### 4-1. Phase 1 구현 (3일)

**1일차: AI 요약 생성 기능 개발**

작업 내용:
- AI에게 대화 요약을 요청하는 함수 생성
- 입력: 사용자 질문 + AI 답변
- 출력: 3문장 요약 (AI가 자유롭게 생성)
- 에러 처리: AI 요청 실패 시 대응 방안

테스트:
- 다양한 대화 패턴으로 요약 품질 검증
- "수유", "수면", "건강" 등 주제별 테스트
- 요약이 3문장인지 확인
- 맥락 파악에 충분한 정보가 담겼는지 검증

**2일차: 대화 맥락 조합 기능 개발**

작업 내용:
- 데이터베이스에서 최근 3개 대화 요약 조회
- 현재 세션의 대화와 함께 텍스트로 조합
- AI 프롬프트에 포함할 형식으로 변환

테스트:
- 최근 3개가 올바르게 조회되는지 확인
- 맥락 텍스트가 올바르게 생성되는지 검증
- 토큰 수 측정 (목표: 450 토큰 이하)

**3일차: 통합 및 전체 테스트**

작업 내용:
- 채팅 API에 요약 생성 기능 통합
- AI 답변 생성 후 자동으로 요약 저장
- 다음 질문 시 자동으로 맥락 불러오기

테스트:
- 실제 대화 시뮬레이션
- "왜 그럴까?" 같은 후속 질문 테스트
- 여러 턴 대화가 자연스럽게 이어지는지 확인
- 3개 이상 대화 후에도 안정적인지 검증

### 4-2. Phase 2 구현 (4일)

**1일차: Redis 연결 및 기본 기능**

작업 내용:
- Redis 연결 설정 (이미 준비된 환경 변수 사용)
- 기본 저장/조회/삭제 기능 구현
- 캐시 클래스 설계
- 타임스탬프 기록 기능

테스트:
- Redis 정상 연결 확인
- 데이터 저장 및 조회 테스트
- 유효 기간(TTL) 작동 확인
- 삭제 기능 테스트

**2일차: 활동 기록 캐시 무효화**

작업 내용:
- 수유, 수면, 기저귀, 체온, 투약 기록 생성 시 캐시 삭제 추가
- 각 기록 수정 시 캐시 삭제
- 각 기록 삭제 시 캐시 삭제
- 메모 필드 포함 확인

수정 대상 파일:
- createActivityService.ts (생성)
- updateActivityService.ts (수정, 있다면)
- deleteActivityService.ts (삭제, 있다면)
- 또는 관련 API 라우트

테스트:
- 각 기록 타입별 캐시 삭제 확인
- 메모 수정 시에도 캐시 삭제되는지 확인
- 타임스탬프가 정확히 기록되는지 확인

**3일차: 성장 기록 캐시 무효화 및 통합**

작업 내용:
- 체중, 키 기록 생성/수정/삭제 시 캐시 삭제 추가
- 채팅 API에 캐싱 로직 통합
  - 캐시 조회
  - 캐시 없으면 데이터베이스 조회
  - 조회한 데이터 캐싱
- 10분 룰 구현

수정 대상 파일:
- createMeasurementService.ts
- updateMeasurementService.ts
- deleteMeasurementService.ts
- chat/route.ts (API)

테스트:
- 성장 기록 후 캐시 삭제 확인
- 전체 캐싱 플로우 테스트
- 10분 룰 작동 확인

**4일차: 실시간성 테스트 및 성능 측정**

중점 테스트:
1. **실시간성 (가장 중요!)**
   - 체온 기록 후 즉시 질문 → 방금 기록 반영 확인
   - 약 투여 후 즉시 질문 → 투약 정보 반영 확인
   - 연속 기록 (체온 → 약 → 수유) 후 질문 → 모두 반영 확인

2. **성능**
   - 캐시 히트 시 응답 시간 측정
   - 캐시 미스 시 응답 시간 측정
   - 캐시 히트율 측정

3. **안정성**
   - 10번 연속 질문 안정성 확인
   - 기록과 질문 교차 반복 테스트
   - 동시 요청 테스트 (가능하다면)

4. **데이터베이스 부하**
   - 캐싱 전후 쿼리 횟수 비교
   - 목표: 90% 감소

### 4-3. 추가 구현 (선택 사항)

**30일 자동 삭제 기능**
- 예상 소요: 반나절
- 우선순위: 낮음 (여유 있을 때)
- 매일 실행되는 크론 작업 설정
- 30일 이상 지난 ChatMessage 삭제
- 삭제 로그 기록

---

## 5. 예상 효과

### 5-1. 성능 개선

**응답 속도:**
- 현재: 평균 2,200밀리초
- 개선 후 (캐시 미스): 2,200밀리초 (동일)
- 개선 후 (캐시 히트): 1,000밀리초
- 평균 (히트율 70% 가정): 1,360밀리초
- 개선율: 38% 빠름

**데이터베이스 부하:**
- 현재: 질문당 1회 풀스캔 조회
- 개선 후: 질문당 0.1회 (캐시 히트율 90% 가정)
- 감소율: 90%
- 효과: 동시 사용자 10배 처리 가능

**서버 리소스:**
- CPU 사용량 50% 감소
- 메모리 사용량 약간 증가 (Redis)
- 전반적인 효율성 대폭 향상

### 5-2. 대화 품질 향상

**맥락 이해:**
- 이전: "왜 그럴까?" → AI가 무엇을 물어보는지 모름
- 개선: "왜 그럴까?" → AI가 이전 대화를 참고하여 정확히 답변

**자연스러운 대화:**
- 이전: 매번 "오늘 수유는...", "오늘 수면은..." 반복 질문 필요
- 개선: "오늘은?", "어제는?", "왜 그래?" 간단한 질문 가능

**깊이 있는 상담:**
- 이전: 평균 1~2턴 대화 후 종료
- 개선: 5~7턴 이상 연속 대화 가능
- 효과: 더 정확한 조언, 더 나은 인사이트

**사용자 만족도:**
- 반복 설명 불필요
- 빠른 응답
- 정확한 정보
- 신뢰도 향상

### 5-3. 비용

**월 추가 비용:**
- AI 요약 생성: 약 500원
- 토큰 증가 (23%): 약 500원
- Redis 비용: 0원 (무료 플랜)
- 합계: 약 1,000원

**기존 대비:**
- 기존: 4,500원/월
- 개선 후: 5,500원/월
- 증가: 22%

**투자 대비 효과:**
- 월 1,000원으로
- 대화 품질 극적 향상
- 서버 성능 개선
- 사용자 만족도 증가
- 재방문율 증가 기대
- **매우 효율적인 투자**

---

## 6. 리스크 및 대응 방안

### 6-1. 리스크 1: 요약 품질 저하

**우려:**
- AI가 중요한 정보를 요약에서 누락
- 부정확한 요약으로 다음 답변 품질 저하

**대응 방안:**
- 다양한 대화 패턴으로 충분한 테스트
- 문제 발견 시 요약 요청 방식 조정
- 최악의 경우: 요약 길이 늘리기 (3문장 → 4문장)
- 비상 대책: 요약 없이 최근 대화 전체 포함 (토큰 증가)

**발생 확률:** 낮음
**영향도:** 중간
**우선순위:** 모니터링 필요

### 6-2. 리스크 2: 캐시 삭제 실패

**우려:**
- 기록 추가 후 캐시 삭제가 실패하여 오래된 데이터 제공
- 아픈 아기의 체온, 약 정보를 AI가 모르는 치명적 상황

**대응 방안:**
- **이중 안전장치 운영**
  - 1차: 기록 즉시 캐시 삭제
  - 2차: 10분 룰 (타임스탬프 확인)
- Redis 삭제는 매우 신뢰성 높은 기본 기능
- 실패 확률 거의 없음
- 만약 1차가 실패해도 2차가 보장
- 로그 기록으로 문제 추적

**발생 확률:** 매우 낮음
**영향도:** 치명적 (그래서 이중 안전장치)
**우선순위:** 높음 (철저한 테스트 필요)

### 6-3. 리스크 3: Redis 서버 장애

**우려:**
- Upstash Redis 서버 다운 시 캐시 사용 불가

**대응 방안:**
- Redis 오류 발생 시 자동으로 데이터베이스 조회로 전환
- 사용자는 응답 시간만 약간 느려질 뿐 정상 사용 가능
- Upstash 99.99% 가용성 보장
- 연간 다운타임: 약 1시간 미만

**발생 확률:** 매우 낮음
**영향도:** 낮음 (자동 복구)
**우선순위:** 낮음

### 6-4. 리스크 4: 비용 초과

**우려:**
- 예상보다 사용량이 많아 비용 증가

**대응 방안:**
- 실제 사용량 주간 모니터링
- 예산 한도 설정 및 알림
- 비용 증가 시 조정 옵션:
  - 캐시 기간 단축 (1일 → 12시간)
  - 요약 개수 축소 (3개 → 2개)
  - Redis 무료 플랜 한도 초과 시 유료 전환 검토

**발생 확률:** 낮음
**영향도:** 낮음 (조정 가능)
**우선순위:** 모니터링

### 6-5. 리스크 5: 10분 룰 오작동

**우려:**
- 10분 룰이 너무 민감하게 작동하여 캐시 효율 저하
- 또는 10분이 부족하여 오래된 데이터 제공

**대응 방안:**
- 실제 사용 패턴 분석
- 필요시 10분 조정 (5분, 15분)
- 캐시 히트율 모니터링
- 사용자 피드백 수집

**발생 확률:** 중간
**영향도:** 낮음 (조정 용이)
**우선순위:** 모니터링 및 튜닝

---

## 7. 성공 기준

### 7-1. 기술적 성공 기준

**필수 달성:**
- [ ] 실시간성 100% 보장 (새 기록 즉시 반영)
- [ ] 캐시 히트율 70% 이상
- [ ] 데이터베이스 쿼리 70% 이상 감소
- [ ] 평균 응답 시간 1,500밀리초 이하

**목표 달성:**
- [ ] 캐시 히트율 90% 이상
- [ ] 데이터베이스 쿼리 90% 감소
- [ ] 평균 응답 시간 1,000밀리초 이하

### 7-2. 품질적 성공 기준

**필수 달성:**
- [ ] 후속 질문 정확한 이해 (맥락 기반)
- [ ] 3턴 이상 자연스러운 대화 가능
- [ ] 단 한 건의 데이터 불일치도 없음 (실시간성)

**목표 달성:**
- [ ] 5턴 이상 자연스러운 대화 가능
- [ ] 사용자 재질문율 50% 감소
- [ ] 평균 대화 턴 수 2배 증가

### 7-3. 비용적 성공 기준

**필수 달성:**
- [ ] 월 추가 비용 2,000원 이하

**목표 달성:**
- [ ] 월 추가 비용 1,000원 이하
- [ ] 토큰 효율성 개선

### 7-4. 사용자 만족도

**측정 방법:**
- 대화 턴 수 증가율
- 재방문율 변화
- 평균 세션 시간 변화
- (가능하다면) 사용자 피드백 수집

**목표:**
- 대화 턴 수 50% 증가
- 재방문율 20% 증가
- 평균 세션 시간 30% 증가

---

## 8. 구현 후 모니터링

### 8-1. 일일 모니터링 항목

**성능 지표:**
- 평균 응답 시간
- 캐시 히트율
- 데이터베이스 쿼리 횟수
- Redis 응답 시간

**품질 지표:**
- 평균 대화 턴 수
- 요약 생성 성공률
- 오류 발생 건수

**비용 지표:**
- 일일 토큰 사용량
- 일일 요약 생성 횟수
- Redis 커맨드 사용량

### 8-2. 주간 분석

**성능 분석:**
- 응답 시간 추세
- 캐시 효율성 변화
- 피크 시간대 성능

**품질 분석:**
- 요약 품질 샘플 검토
- 맥락 이해 정확도
- 사용자 대화 패턴

**비용 분석:**
- 주간 총 비용
- 예산 대비 사용률
- 최적화 가능 영역

### 8-3. 지속적 개선

**1개월 후:**
- 전체 데이터 분석
- 사용자 피드백 종합
- 최적화 방안 도출
- 다음 개선 계획 수립

**개선 후보:**
- 요약 프롬프트 최적화
- 캐시 전략 튜닝 (TTL, 10분 룰 조정)
- 비용 효율성 개선
- 추가 기능 검토

---

## 9. 체크리스트

### 9-1. Phase 1 체크리스트

**개발:**
- [ ] AI 요약 생성 함수 구현
- [ ] 대화 맥락 조합 함수 구현
- [ ] ChatMessage 테이블 summary 필드 활용
- [ ] 채팅 API 통합

**테스트:**
- [ ] 요약 품질 테스트 (다양한 주제)
- [ ] 3문장 제약 확인
- [ ] 맥락 전달 테스트
- [ ] 후속 질문 이해 테스트
- [ ] 3개 이상 대화 안정성 테스트

**배포:**
- [ ] 스테이징 환경 테스트
- [ ] 프로덕션 배포
- [ ] 모니터링 설정

### 9-2. Phase 2 체크리스트

**개발:**
- [ ] Redis 연결 설정 (이미 완료)
- [ ] 캐시 클래스 구현
- [ ] 활동 기록 캐시 무효화 (5가지 타입)
- [ ] 성장 기록 캐시 무효화
- [ ] 10분 룰 구현
- [ ] 채팅 API 캐싱 로직 통합

**테스트:**
- [ ] Redis 연결 테스트
- [ ] 캐시 저장/조회/삭제 테스트
- [ ] 각 기록 타입별 캐시 무효화 테스트
- [ ] 실시간성 테스트 (최우선!)
  - [ ] 체온 기록 후 즉시 질문
  - [ ] 투약 기록 후 즉시 질문
  - [ ] 연속 기록 후 즉시 질문
- [ ] 10분 룰 작동 확인
- [ ] 캐시 히트율 측정
- [ ] 성능 측정

**배포:**
- [ ] 스테이징 환경 테스트
- [ ] 실시간성 최종 검증
- [ ] 프로덕션 배포
- [ ] 모니터링 설정

### 9-3. 추가 구현 체크리스트

**30일 자동 삭제 (선택):**
- [ ] 크론 작업 설정
- [ ] 삭제 로직 구현
- [ ] 삭제 로그 기록
- [ ] 테스트
- [ ] 배포

---

## 10. 참고 사항

### 10-1. 기술 스택

**사용 기술:**
- Next.js (프레임워크)
- Prisma (데이터베이스 ORM)
- Upstash Redis (캐시)
- Google Gemini 2.5 Flash Lite (AI 모델)

**환경 변수:**
- UPSTASH_REDIS_REST_URL (이미 설정 완료)
- UPSTASH_REDIS_REST_TOKEN (이미 설정 완료)

### 10-2. 중요 파일 목록

**Phase 1 수정 대상:**
- src/features/ai-chat/services/summaryGenerator.ts (신규)
- src/features/ai-chat/services/contextBuilder.ts (신규)
- src/app/api/chat/route.ts (수정)

**Phase 2 수정 대상:**
- src/shared/lib/redis.ts (신규)
- src/features/activities/services/createActivityService.ts (수정)
- src/features/measurements/services/createMeasurementService.ts (수정)
- src/features/measurements/services/updateMeasurementService.ts (수정)
- src/features/measurements/services/deleteMeasurementService.ts (수정)
- src/app/api/chat/route.ts (수정)

### 10-3. 데이터베이스 스키마

**사용 테이블:**
- ChatMessage (대화 저장, summary 필드 활용)
- Activity (활동 기록, memo 필드 포함)
- BabyMeasurement (성장 기록)

**제외 테이블:**
- Note (노트, 캐시 무효화 대상 아님)

---

## 11. 마무리

### 11-1. 핵심 요약

**Phase 1: 대화 맥락**
- AI가 대화를 3문장으로 요약
- 최근 3개 요약 활용
- 자연스러운 대화 가능

**Phase 2: 데이터 캐싱**
- Redis로 7일 데이터 캐싱
- 기록 즉시 캐시 삭제
- 10분 룰로 이중 보장
- 실시간성 100%

**예상 효과:**
- 응답 속도 38% 향상
- 데이터베이스 부하 90% 감소
- 대화 품질 대폭 향상
- 월 비용 1,000원 증가

### 11-2. 다음 단계

1. 이 계획서 검토 및 승인
2. Phase 1 구현 시작 (3일)
3. Phase 1 테스트 및 배포
4. Phase 2 구현 시작 (4일)
5. Phase 2 테스트 및 배포
6. 1주일 모니터링
7. 최적화 및 개선

### 11-3. 연락처

**질문이나 피드백:**
- 계획서 내용에 대한 질문
- 구현 중 기술적 이슈
- 우선순위 변경 요청

**언제든지 문의하세요!**

---

**문서 버전:** 1.0
**최종 수정:** 2025-12-12
**다음 리뷰:** Phase 1 완료 후
