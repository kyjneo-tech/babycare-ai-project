generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id            String         @id @default(cuid())
  email         String         @unique
  password      String
  name          String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  Activities    Activity[]
  ChatMessages  ChatMessage[]
  FamilyMembers FamilyMember[]
  Notes         Note[]
  Settings      UserSettings?
  ChatMetrics   ChatMetrics[]
}

model UserSettings {
  id                   String   @id @default(cuid())
  userId               String   @unique
  unit                 String   @default("ml")
  timeFormat           String   @default("24h")
  notificationsEnabled Boolean  @default(true)
  notificationTimes    Json?
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  User                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Family {
  id               String         @id @default(cuid())
  name             String
  inviteCode       String         @unique
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  inviteCodeExpiry DateTime?
  Babies           Baby[]
  FamilyMembers    FamilyMember[]
}

model Baby {
  id           String            @id @default(cuid())
  name         String
  gender       String
  birthDate    DateTime
  birthTime    String
  photoUrl     String?
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  familyId     String
  aiSettings   Json?
  Activities   Activity[]
  Family       Family            @relation(fields: [familyId], references: [id], onDelete: Cascade)
  Measurements BabyMeasurement[]
  ChatMessages ChatMessage[]
  Notes        Note[]
  ChatMetrics  ChatMetrics[]

  @@index([familyId])
}

model FamilyMember {
  userId     String
  familyId   String
  role       String
  relation   String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  permission String   @default("member")
  Family     Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  User       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, familyId])
  @@index([familyId])
}

model Activity {
  id                 String       @id @default(cuid())
  babyId             String
  userId             String
  type               ActivityType
  startTime          DateTime
  endTime            DateTime?
  memo               String?
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  feedingType        String?
  feedingAmount      Int?
  breastSide         String?
  sleepType          String?
  duration           Int?
  diaperType         String?
  medicineAmount     String?
  medicineName       String?
  medicineUnit       String?
  temperature        Float?
  stoolCondition     String?
  reaction           String?
  isSplit            Boolean      @default(false)
  originalActivityId String?
  splitSequence      Int?
  Baby               Baby         @relation(fields: [babyId], references: [id], onDelete: Cascade)
  OriginalActivity   Activity?    @relation("SplitActivities", fields: [originalActivityId], references: [id], onDelete: Cascade)
  SplitActivities    Activity[]   @relation("SplitActivities")
  User               User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([babyId, createdAt(sort: Desc)])
  @@index([originalActivityId])
}

model ChatMessage {
  id        String   @id @default(cuid())
  babyId    String
  userId    String
  message   String
  reply     String
  summary   Json?
  createdAt DateTime @default(now())
  Baby      Baby     @relation(fields: [babyId], references: [id], onDelete: Cascade)
  User      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([babyId, createdAt(sort: Desc)])
}

model BabyMeasurement {
  id         String   @id @default(cuid())
  babyId     String
  weight     Float
  height     Float
  measuredAt DateTime
  note       String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  Baby       Baby     @relation(fields: [babyId], references: [id], onDelete: Cascade)

  @@index([babyId, measuredAt(sort: Desc)])
}

model Note {
  id                String              @id @default(cuid())
  babyId            String
  userId            String
  type              NoteType
  title             String
  content           String?
  dueDate           DateTime?
  completed         Boolean             @default(false)
  completedAt       DateTime?
  priority          Priority?
  tags              String[]
  metadata          Json?
  reminderDays      Int[]
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  MilestoneProgress MilestoneProgress[]
  Baby              Baby                @relation(fields: [babyId], references: [id], onDelete: Cascade)
  User              User                @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([babyId, type])
  @@index([babyId, dueDate])
  @@index([babyId, completed])
}

model MilestoneProgress {
  id         String    @id @default(cuid())
  noteId     String
  category   String
  itemIndex  Int
  achieved   Boolean   @default(false)
  achievedAt DateTime?
  memo       String?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  Note       Note      @relation(fields: [noteId], references: [id], onDelete: Cascade)

  @@unique([noteId, category, itemIndex])
  @@index([noteId])
}

enum ActivityType {
  FEEDING
  SLEEP
  DIAPER
  MEDICINE
  TEMPERATURE
}

enum NoteType {
  MEMO
  TODO
  VACCINATION
  HEALTH_CHECKUP
  MILESTONE
  WONDER_WEEK
  SLEEP_REGRESSION
  FEEDING_STAGE
  APPOINTMENT
}

enum Priority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

// ============================================================
// AI 상담 모니터링 모델
// ============================================================

model ChatMetrics {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  // 기본 정보
  babyId   String
  userId   String
  question String @db.Text
  answer   String @db.Text

  // 분류 정보
  complexity    String
  historyTier   Int
  historyCount  Int
  historyReason String
  mode          String

  // 성능 지표 (ms)
  totalTime        Int
  orchestratorTime Int?
  answererTime     Int?
  toolsTime        Int?
  databaseTime     Int?

  // 비용 지표
  inputTokens   Int
  outputTokens  Int
  totalTokens   Int
  estimatedCost Float
  aiCallCount   Int

  // 도구 사용
  toolsCalled  String[]
  toolsSuccess Boolean
  toolsData    Json?

  // 결과 및 품질
  success      Boolean
  errorType    String?
  errorMessage String? @db.Text

  dataAvailable Boolean
  missingInfo   String[]

  // 사용자 피드백
  userFeedback Json?
  feedbackAt   DateTime?

  // 관계
  Baby Baby @relation(fields: [babyId], references: [id], onDelete: Cascade)
  User User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 인덱스
  @@index([babyId, createdAt(sort: Desc)])
  @@index([userId, createdAt(sort: Desc)])
  @@index([createdAt(sort: Desc)])
  @@index([complexity])
  @@index([success])
}

model MetricsAlert {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())

  type     String
  severity String

  title   String
  message String @db.Text

  metadata Json

  resolved   Boolean   @default(false)
  resolvedAt DateTime?

  @@index([createdAt(sort: Desc)])
  @@index([type])
  @@index([resolved])
}

model DailyMetricsSummary {
  id   String   @id @default(cuid())
  date DateTime @unique

  totalQuestions   Int
  simpleQuestions  Int
  complexQuestions Int

  tier1Count Int
  tier2Count Int
  tier3Count Int

  avgResponseTime Float
  minResponseTime Int
  maxResponseTime Int

  totalTokens        Int
  totalCost          Float
  avgCostPerQuestion Float

  successRate Float
  errorCount  Int

  feedbackCount    Int
  helpfulCount     Int
  satisfactionRate Float?

  topTools     Json
  topQuestions Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([date(sort: Desc)])
}
