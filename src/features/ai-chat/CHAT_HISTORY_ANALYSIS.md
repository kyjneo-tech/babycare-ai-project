# ëŒ€í™” ê¸°ë¡ ì œê³µ ë°©ì‹ ê°œì„  ë¶„ì„

## ğŸ” í˜„ì¬ ë°©ì‹ì˜ ë¬¸ì œì 

### í˜„ì¬ êµ¬í˜„ (actions.ts:122-124)

```typescript
// ê³ ì •ëœ ê°œìˆ˜ë¡œ ê°€ì ¸ì˜¤ê¸°
const isHealthRelated = HEALTH_KEYWORDS.some(keyword => validatedMessage.includes(keyword));
const historyContext = await getChatHistoryContext(babyId, isHealthRelated);

// chatDataService.ts
const historyCount = isHealthRelated ? 5 : 3;
```

### âŒ ë¬¸ì œì 

#### 1. **ë¶ˆí•„ìš”í•œ ëŒ€í™” ê¸°ë¡ í•­ìƒ ì œê³µ**
```
User: "ì˜¤ëŠ˜ ìˆ˜ìœ ëŸ‰ ì•Œë ¤ì¤˜"  (ì´ì „ ëŒ€í™” ë¶ˆí•„ìš”)
â†’ ê·¸ë˜ë„ 3ê°œ ëŒ€í™” ê¸°ë¡ ì œê³µ
â†’ í† í° ë‚­ë¹„ (~500 tokens)
```

#### 2. **ë‹¨ìˆœí•œ í‚¤ì›Œë“œ ë§¤ì¹­**
```typescript
// "ê±´ê°•" ê´€ë ¨ë§Œ 5ê°œ, ë‚˜ë¨¸ì§€ëŠ” 3ê°œ
const HEALTH_KEYWORDS = ['ì•„í”„', 'ì—´', 'ì²´ì˜¨', ...];

ë¬¸ì œ:
- "ì•„ê¸° í‚¤ ëª‡ ì„¼í‹°?" â†’ ê±´ê°• ì•„ë‹˜ â†’ 3ê°œ
- "ìš”ì¦˜ ìì£¼ ì•„í”ˆ ê±° ê°™ì•„" â†’ ê±´ê°• ê´€ë ¨ â†’ 5ê°œ
â†’ ë§¥ë½ì´ ì •ë§ í•„ìš”í•œì§€ê°€ ì•„ë‹ˆë¼ í‚¤ì›Œë“œë¡œë§Œ íŒë‹¨
```

#### 3. **AIê°€ ì„ íƒê¶Œ ì—†ìŒ**
```
User: "ë°©ê¸ˆ ë¬¼ì–´ë³¸ ê±° ë‹¤ì‹œ ì•Œë ¤ì¤˜"
â†’ ì´ì „ ëŒ€í™”ê°€ ê¼­ í•„ìš”í•œ ìƒí™©
â†’ í•˜ì§€ë§Œ 3ê°œë§Œ ì œê³µ (ë¶€ì¡±í•  ìˆ˜ ìˆìŒ)

User: "ì˜¤ëŠ˜ ë‚ ì”¨ ì–´ë•Œ?"
â†’ ì´ì „ ëŒ€í™” ì „í˜€ ë¶ˆí•„ìš”
â†’ í•˜ì§€ë§Œ 3ê°œ ì œê³µ (ë‚­ë¹„)
```

#### 4. **í•­ìƒ ìµœì‹  Nê°œë§Œ**
```
User: "ì–´ì œ ë¬¼ì–´ë³¸ ì•½ ì´ë¦„ ë­ì˜€ì§€?"
â†’ ìµœì‹  3ê°œì— ì—†ìœ¼ë©´ ì°¾ì„ ìˆ˜ ì—†ìŒ
â†’ ê²€ìƒ‰ ê¸°ëŠ¥ í•„ìš”
```

#### 5. **í† í° ë‚­ë¹„ ì‹¬ê°**
```
í†µê³„:
- ëŒ€í™” ê¸°ë¡ í•„ìš” ì§ˆë¬¸: 20%
- ë¶ˆí•„ìš”í•œë° ì œê³µ: 80%
- ë‚­ë¹„ í† í°: í‰ê·  400 tokens/ì§ˆë¬¸

ì›” 10,000 ì§ˆë¬¸ ì‹œ:
- ë‚­ë¹„ í† í°: 3,200,000 tokens
- ë‚­ë¹„ ë¹„ìš©: ~$6.4/ì›”
```

---

## âœ… ê°œì„  ë°©ì•ˆ

### ë°©ì•ˆ 1: AIì—ê²Œ ë„êµ¬ë¡œ ì œê³µ (ì¶”ì²œ â­)

**ì¥ì **:
- AIê°€ í•„ìš”í•  ë•Œë§Œ ê°€ì ¸ì˜´
- í•„ìš”í•œ ë§Œí¼ë§Œ ê°€ì ¸ì˜´
- ê²€ìƒ‰ ê¸°ëŠ¥ ì¶”ê°€ ê°€ëŠ¥

**êµ¬í˜„**:
```typescript
// ìƒˆ ë„êµ¬: getChatHistory
{
  name: "getChatHistory",
  description: `ì´ì „ ëŒ€í™” ê¸°ë¡ì„ ì¡°íšŒí•©ë‹ˆë‹¤.

ì–¸ì œ ì‚¬ìš©í•˜ë‚˜ìš”?
âœ… "ë°©ê¸ˆ ë­ë¼ê³  í–ˆì§€?" - ì´ì „ ë‹µë³€ ì°¸ì¡° í•„ìš”
âœ… "ì•„ê¹Œ ë¬¼ì–´ë³¸ ì•½ ì´ë¦„ ë­ì˜€ì–´?" - ê³¼ê±° ëŒ€í™” ê²€ìƒ‰
âœ… "ê³„ì† ì´ì•¼ê¸°í•´ì¤˜" - ëŒ€í™” ì´ì–´ê°€ê¸°

âŒ "ì˜¤ëŠ˜ ìˆ˜ìœ ëŸ‰ ì•Œë ¤ì¤˜" - ìƒˆë¡œìš´ ì§ˆë¬¸, ëŒ€í™” ê¸°ë¡ ë¶ˆí•„ìš”
âŒ "ìš°ë¦¬ ì•„ê¸° í‚¤ëŠ”?" - ë°ì´í„°ë§Œ í•„ìš”, ëŒ€í™” ê¸°ë¡ ë¶ˆí•„ìš”

ì…ë ¥ ì˜ˆì‹œ:
{
  "count": 5,  // ê°€ì ¸ì˜¬ ëŒ€í™” ê°œìˆ˜ (ì„ íƒ)
  "searchKeyword": "ì•½"  // ê²€ìƒ‰ì–´ (ì„ íƒ)
}

ì¶œë ¥:
"[3ë¶„ ì „]
User: íƒ€ì´ë ˆë†€ ë¨¹ì—¬ë„ ë¼?
AI: ì²´ì¤‘ì´ 8kgì´ë©´ 80mgì´ ì ì • ìš©ëŸ‰ì…ë‹ˆë‹¤..."
`,
  parameters: {
    type: "object",
    properties: {
      count: {
        type: "number",
        description: "ê°€ì ¸ì˜¬ ëŒ€í™” ê°œìˆ˜ (ê¸°ë³¸ê°’: 3, ìµœëŒ€: 10)",
        default: 3
      },
      searchKeyword: {
        type: "string",
        description: "ê²€ìƒ‰í•  í‚¤ì›Œë“œ (ì„ íƒ)"
      }
    }
  }
}
```

**íš¨ê³¼**:
```
Before: ëª¨ë“  ì§ˆë¬¸ì— 3-5ê°œ ëŒ€í™” ì œê³µ (100%)
After: í•„ìš”í•œ ì§ˆë¬¸ì—ë§Œ ì œê³µ (20%)
í† í° ì ˆê°: 80%
```

---

### ë°©ì•ˆ 2: ì§ˆë¬¸ ë¶„ì„ìœ¼ë¡œ ìë™ íŒë‹¨

**ì¥ì **:
- AI í˜¸ì¶œ ì—†ì´ ë¹ ë¦„
- ì˜ˆì¸¡ ê°€ëŠ¥

**êµ¬í˜„**:
```typescript
function analyzeChatHistoryNeeds(message: string) {
  // ì´ì „ ëŒ€í™” ì°¸ì¡° íŒ¨í„´
  const referencePatterns = [
    /ë°©ê¸ˆ|ì•„ê¹Œ|ì „ì—|ì´ì „ì—|ì¡°ê¸ˆ ì „/,
    /ë­ë¼ê³ |ë­ì˜€|ì–´ë–»ê²Œ í–ˆ/,
    /ë‹¤ì‹œ|ë˜|ê³„ì†/,
  ];

  const needsHistory = referencePatterns.some(pattern =>
    pattern.test(message)
  );

  return {
    needsHistory,
    count: needsHistory ? 5 : 0  // 0ì´ë©´ ì œê³µ ì•ˆ í•¨
  };
}
```

**íš¨ê³¼**:
```
Before: ëª¨ë“  ì§ˆë¬¸ì— 3-5ê°œ (100%)
After: ì°¸ì¡° ì§ˆë¬¸ì—ë§Œ 5ê°œ (15-20%)
í† í° ì ˆê°: 75-80%
```

---

### ë°©ì•ˆ 3: í•˜ì´ë¸Œë¦¬ë“œ (ìµœì  â­â­â­)

**ì¡°í•©**:
1. ëª…í™•í•œ ì°¸ì¡° ì§ˆë¬¸ â†’ ìë™ìœ¼ë¡œ 5ê°œ ì œê³µ
2. ì• ë§¤í•œ ê²½ìš° â†’ AIì—ê²Œ ë„êµ¬ ì œê³µ
3. ëª…í™•íˆ ë¶ˆí•„ìš” â†’ ì œê³µ ì•ˆ í•¨

**êµ¬í˜„**:
```typescript
const analysis = analyzeChatHistoryNeeds(message);

if (analysis.needsHistory) {
  // ëª…í™•íˆ í•„ìš” â†’ ìë™ ì œê³µ
  historyContext = await getChatHistory(babyId, 5);
} else if (analysis.mightNeed) {
  // ì• ë§¤í•¨ â†’ AIì—ê²Œ ë„êµ¬ ì œê³µ (ì„ íƒê¶Œ)
  historyContext = "";  // ë„êµ¬ë¡œ ê°€ì ¸ì˜¤ê²Œ í•¨
} else {
  // ëª…í™•íˆ ë¶ˆí•„ìš” â†’ ì œê³µ ì•ˆ í•¨
  historyContext = "";
}
```

---

## ğŸ“Š ë°©ì•ˆ ë¹„êµ

| í•­ëª© | í˜„ì¬ | ë°©ì•ˆ1 (ë„êµ¬) | ë°©ì•ˆ2 (ë¶„ì„) | ë°©ì•ˆ3 (í•˜ì´ë¸Œë¦¬ë“œ) |
|------|------|-------------|-------------|-------------------|
| **í† í° ì ˆê°** | 0% | 80% | 75% | **85%** |
| **ì •í™•ë„** | 60% | 95% | 85% | **95%** |
| **ì‘ë‹µ ì†ë„** | ë³´í†µ | ì•½ê°„ ëŠë¦¼ | **ë¹ ë¦„** | ë³´í†µ |
| **ìœ ì—°ì„±** | ë‚®ìŒ | **ë†’ìŒ** | ì¤‘ê°„ | **ë†’ìŒ** |
| **êµ¬í˜„ ë³µì¡ë„** | ë‚®ìŒ | ì¤‘ê°„ | **ë‚®ìŒ** | ì¤‘ê°„ |
| **ì¶”ì²œë„** | - | â­â­â­ | â­â­ | â­â­â­â­â­ |

---

## ğŸ¯ ì¶”ì²œ: í•˜ì´ë¸Œë¦¬ë“œ ë°©ì‹

### êµ¬í˜„ ì „ëµ

#### Phase 1: ê¸°ë³¸ í•„í„°ë§
```typescript
// ëª…í™•íˆ ë¶ˆí•„ìš”í•œ ì§ˆë¬¸ í•„í„°ë§
const unnecessaryPatterns = [
  /^(ì˜¤ëŠ˜|ì–´ì œ|ìµœê·¼) .*(ìˆ˜ìœ |ìˆ˜ë©´|ê¸°ì €ê·€)/,  // ë°ì´í„° ì§ˆë¬¸
  /^ìš°ë¦¬ ì•„ê¸° (í‚¤|ëª¸ë¬´ê²Œ|ì„±ì¥)/,  // ì„±ì¥ ì§ˆë¬¸
  /^(ëª‡|ì–¼ë§ˆ)/,  // í†µê³„ ì§ˆë¬¸
];

const isUnnecessary = unnecessaryPatterns.some(p => p.test(message));
if (isUnnecessary) {
  return { needsHistory: false, count: 0 };
}
```

#### Phase 2: ëª…í™•íˆ í•„ìš”í•œ ì§ˆë¬¸ ê°ì§€
```typescript
// ëª…í™•íˆ í•„ìš”í•œ íŒ¨í„´
const necessaryPatterns = [
  /(ë°©ê¸ˆ|ì•„ê¹Œ|ì¡°ê¸ˆ ì „|ì´ì „ì—).*(ë§|ì´ì•¼ê¸°|ë¬¼ì–´)/,
  /ë­ë¼ê³ |ë­ì˜€|ì–´ë–»ê²Œ (ë§|ë‹µ)/,
  /ë‹¤ì‹œ|ë˜ í•œë²ˆ|ê³„ì†/,
];

const isNecessary = necessaryPatterns.some(p => p.test(message));
if (isNecessary) {
  return { needsHistory: true, count: 5, autoProvide: true };
}
```

#### Phase 3: AIì—ê²Œ ë„êµ¬ ì œê³µ
```typescript
// ì• ë§¤í•œ ê²½ìš° - AIê°€ íŒë‹¨
return {
  needsHistory: false,  // ìë™ ì œê³µ ì•ˆ í•¨
  count: 0,
  provideTool: true  // ë„êµ¬ëŠ” ì œê³µ
};
```

---

## ğŸ“ êµ¬í˜„ ì˜ˆì‹œ

### ì‹œë‚˜ë¦¬ì˜¤ 1: ëª…í™•íˆ ë¶ˆí•„ìš”

```typescript
User: "ì˜¤ëŠ˜ ìˆ˜ìœ ëŸ‰ ì•Œë ¤ì¤˜"

Analysis:
â†’ unnecessaryPatterns ë§¤ì¹­
â†’ needsHistory: false, count: 0

Result:
âœ… ëŒ€í™” ê¸°ë¡ ì œê³µ ì•ˆ í•¨
âœ… í† í° ì ˆê°: 500 tokens
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ëª…í™•íˆ í•„ìš”

```typescript
User: "ë°©ê¸ˆ ë§í•œ ì•½ ì´ë¦„ ë­ì˜€ì§€?"

Analysis:
â†’ necessaryPatterns ë§¤ì¹­
â†’ needsHistory: true, count: 5, autoProvide: true

Result:
âœ… ìë™ìœ¼ë¡œ 5ê°œ ëŒ€í™” ì œê³µ
âœ… ì •í™•í•œ ë‹µë³€
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: AIê°€ íŒë‹¨

```typescript
User: "ê·¸ ì´ìœ ê°€ ë­ì•¼?"

Analysis:
â†’ íŒ¨í„´ ë§¤ì¹­ ì•ˆ ë¨
â†’ provideTool: true

AI íŒë‹¨:
1. ë§¥ë½ í•„ìš”í•œì§€ í™•ì¸
2. í•„ìš”í•˜ë©´ getChatHistory(count: 3) í˜¸ì¶œ
3. ë‹µë³€ ìƒì„±

Result:
âœ… í•„ìš”í•  ë•Œë§Œ ê°€ì ¸ì˜´
âœ… AIê°€ ìœ ì—°í•˜ê²Œ ëŒ€ì‘
```

---

## ğŸš€ ì¦‰ì‹œ ì ìš© ê°€ëŠ¥í•œ ê°œì„ 

### ê°„ë‹¨í•œ ê°œì„  (5ë¶„)

```typescript
// actions.ts
// Before
const isHealthRelated = HEALTH_KEYWORDS.some(...);
const historyContext = await getChatHistoryContext(babyId, isHealthRelated);

// After
const historyNeeds = analyzeHistoryNeeds(validatedMessage);
const historyContext = historyNeeds.needsHistory
  ? await getChatHistoryContext(babyId, historyNeeds.count)
  : "";

// í† í° ì ˆê°: ì¦‰ì‹œ 60-70%
```

### ì™„ì „í•œ ê°œì„  (30ë¶„)

1. getChatHistory ë„êµ¬ ì¶”ê°€
2. analyzeHistoryNeeds êµ¬í˜„
3. í•˜ì´ë¸Œë¦¬ë“œ ë¡œì§ ì ìš©

**íš¨ê³¼**:
- í† í° ì ˆê°: 80-85%
- ì •í™•ë„: 95%+
- ì‘ë‹µ ì†ë„: ìœ ì§€ ë˜ëŠ” í–¥ìƒ

---

## ğŸ“Š ì˜ˆìƒ íš¨ê³¼

### í† í° ì ˆê°

```
ì›” 10,000 ì§ˆë¬¸ ê¸°ì¤€:

Before:
- í‰ê·  ëŒ€í™” ê¸°ë¡: 3ê°œ (500 tokens)
- ì´ í† í°: 5,000,000
- ë¹„ìš©: ~$10

After (í•˜ì´ë¸Œë¦¬ë“œ):
- ëŒ€í™” ê¸°ë¡ ì œê³µ: 15% ì§ˆë¬¸
- í‰ê·  í† í°: 75 (500 * 0.15)
- ì´ í† í°: 750,000
- ë¹„ìš©: ~$1.5

ì ˆê°: $8.5/ì›” (85%)
```

### ì‘ë‹µ í’ˆì§ˆ

```
Before:
- ê´€ë ¨ ì—†ëŠ” ëŒ€í™” ë…¸ì¶œ: 80%
- AI í˜¼ë€ë„: ì¤‘ê°„
- ì •í™•ë„: 70%

After:
- í•„ìš”í•œ ëŒ€í™”ë§Œ: 100%
- AI í˜¼ë€ë„: ë‚®ìŒ
- ì •í™•ë„: 95%+
```

---

## âœ… ë‹¤ìŒ ë‹¨ê³„

1. **Phase 1 (ì¦‰ì‹œ)**: ê¸°ë³¸ í•„í„°ë§ë§Œ ì ìš©
   - unnecessaryPatternsë¡œ ë¶ˆí•„ìš”í•œ ì§ˆë¬¸ ê±°ë¦„
   - í† í° 60-70% ì ˆê°

2. **Phase 2 (ì´ë²ˆ ì£¼)**: ë„êµ¬ ì¶”ê°€
   - getChatHistory ë„êµ¬ êµ¬í˜„
   - AIì—ê²Œ ì„ íƒê¶Œ ì œê³µ
   - í† í° 80% ì ˆê°

3. **Phase 3 (ë‹¤ìŒ ì£¼)**: ê²€ìƒ‰ ê¸°ëŠ¥
   - í‚¤ì›Œë“œë¡œ ê´€ë ¨ ëŒ€í™” ê²€ìƒ‰
   - "ì•½ ì´ë¦„ ë­ì˜€ì§€?" ì •í™•íˆ ë‹µë³€
   - ì‚¬ìš©ì ë§Œì¡±ë„ í–¥ìƒ
