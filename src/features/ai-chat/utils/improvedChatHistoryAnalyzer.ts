/**
 * 대화 기록 최적화 분석기
 * 
 * 역할:
 * 사용자 질문을 분석하여 이전 대화 기록을 몇 개 포함할지 결정합니다.
 * 불필요한 토큰 소비를 줄이고, 필요한 맥락만 제공하여 비용 효율성을 높입니다.
 */

export interface ChatHistoryStrategy {
  count: number;           // 포함할 개수
  reason: string;          // 판단 이유
  tier: 1 | 2 | 3;        // 우선순위 (1: 낮음/없음, 2: 중간/맥락, 3: 높음/필수)
  estimatedTokens: number; // 예상 토큰 (대략 2000자 = ~500 토큰)
}

export function analyzeOptimalChatHistory(
  message: string
): ChatHistoryStrategy {
  const msg = message.toLowerCase().trim();

  // ========================================
  // Tier 1: 절대 불필요 (데이터 질문) - 0개
  // ========================================
  // 독립적인 데이터 조회 질문은 이전 대화 맥락이 필요 없음

  const tier1Patterns = [
    // 시간 + 데이터 키워드
    /^(오늘|어제|그저께|최근|지난주|이번주|이번달|올해).*(수유|수면|잠|기저귀|체온|약|몸무게|키|신장)/,
    // 아기 신체 정보
    /^우리 아기 (키|몸무게|체중|성장|발달)/,
    // 정량적 질문
    /^(몇|얼마|평균|총).*(번|회|시간|분|ml|kg|cm)/,
    // 트렌드/비교/상태 확인
    /(권장|정상|평균|괜찮|적절|비교|트렌드|변화|증가|감소|추이)/,
  ];

  for (const pattern of tier1Patterns) {
    if (pattern.test(msg)) {
      return {
        count: 0,
        reason: "독립적인 데이터 질문 - 대화 기록 불필요",
        tier: 1,
        estimatedTokens: 0,
      };
    }
  }

  // ========================================
  // Tier 3: 필수 (이전 대화 참조) - 3개
  // ========================================
  // 지시 대명사나 재질문 등 이전 대화를 모르면 답변 불가능한 경우

  const tier3Patterns = [
    // 이전 발언 참조
    /(방금|아까|조금 전|이전에|전에).*(말|이야기|물어|답|대답|질문)/,
    // 재확인/재요청
    /뭐라고|뭐였|어떻게 (말|답|대답)/,
    /(다시|또|또 한번|한번 더|계속해)/,
    // 지시 대명사 시작 (문두)
    /^(그|그거|그게|그건|그래서|왜)\s/,
    /^(그|그거|그게|그건|그래서|왜)$/,
    // 이유/설명 요청 (문두)
    /^(이유|원인|왜|어떻게|설명)/,
  ];

  for (const pattern of tier3Patterns) {
    if (pattern.test(msg)) {
      return {
        count: 3,
        reason: "이전 대화 직접 참조 - 최소 3개 필요",
        tier: 3,
        estimatedTokens: 1500, // 3개 * 500자(약 125토큰) * 4(한글) 보수적 접근
      };
    }
  }

  // ========================================
  // Tier 2: 맥락 도움됨 (건강/걱정) - 2개
  // ========================================
  // 증상이나 감정 표현은 연속적인 맥락일 가능성이 높음

  const healthKeywords = [
    '아프', '열', '체온', '증상', '병', '토', '설사',
    '기침', '콧물', '구토', '통증', '울', '보채',
    '이상', '걱정', '불안', '문제', '힘들'
  ];

  const isHealthRelated = healthKeywords.some(k => msg.includes(k));

  if (isHealthRelated) {
    return {
      count: 2,
      reason: "건강/걱정 관련 - 맥락 도움될 수 있음",
      tier: 2,
      estimatedTokens: 1000, 
    };
  }

  // ========================================
  // 기본: 불필요 (새로운 질문) - 0개
  // ========================================
  // 위 조건에 해당하지 않는 일반 질문은 새로운 주제로 간주

  return {
    count: 0,
    reason: "새로운 독립 질문 - 대화 기록 불필요",
    tier: 1,
    estimatedTokens: 0,
  };
}
